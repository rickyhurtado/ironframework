// form.library.min.js v1.0
I.Library.Form={session:{time:1800,warning:0,expired:0},warning:null,response:{yes:null,no:null},expired:null,inputs:"[type=text], [type=password], [type=radio], [type=checkbox], textarea, select",init:function(a){this.settings=a.settings;this.settingFormDate=a.settingFormDate;this.form=a.form;this.inputContainer=a.inputContainer;this.collections=a.collections;this.session.time=a.sessionTime?a.sessionTime:this.session.time;a.warning&&a.response.yes&&a.response.no&&a.expired&&(this.warning=a.warning, this.response.yes=a.response.yes,this.response.no=a.response.no,this.expired=a.expired);this.bindEvents()},bindEvents:function(){var a=this;$(document).on("blur change","[data-form="+this.form+"] "+a.inputs,function(){var b=$(this).attr("type");if(b&&b.match(/radio|checkbox/)){var c=$(this).data("form-input-group"),e=$(this).data("form-input-other"),d=$("[data-form-input-group="+c+"]:checked"),c=$("[data-form-input-group="+c+"].form-input-uncheck-all");$(this).hasClass("form-input-uncheck-all")?c.is(":checked")&& (d.not(".form-input-uncheck-all").click(),c.is(":checked")||c.click()):(0<d.length&&c.is(":checked")&&c.click(),0==d.length&&c.click());if(e||"radio"==b)e=$(this).attr("id"),e=$("[data-form-input-other="+e+"]"),d=e.find("[type=text]"),"radio"==b&&$(this).closest(a.inputContainer).find("div[data-form-input-other]").addClass("hide").find("[type=text]").each(function(){$(this).data("form-rules",!1).val("")}),$(this).is(":checked")?(d.attr("data-form-rules","required"),d.data("form-rules","required"), e.removeClass("hide")):($(this).val(""),e.addClass("hide"),d.data("form-rules",!1).val(""),a.validateInput(d))}d=$("#"+$(this).closest("[data-form-input-other]").data("form-input-other"));d.data("form-input-other")?(d.val($(this).val()),a.updateModel(d)):d="";$(this).attr("data-form-rules")&&a.validateInput($(this));""==d&&a.updateModel($(this))});a.warning&&a.response.yes&&a.response.no&&a.expired&&($(document).on("keyup click mousemove","body",function(){a.session.warning&&a.sessionStart()}),$(document).on("click", "[data-form-continue-response]",function(){clearTimeout(a.session.warning);clearTimeout(a.session.expired);$(this).data("form-continue-response")?(a.response.yes(),a.sessionStart()):(a.session.warning=!1,a.session.expired=0,a.response.no())}))},sessionStart:function(){var a=this,b=a.session.time/2*1E3;clearTimeout(a.session.warning);a.session.warning=setTimeout(function(){0<a.settings.get(a.settingFormDate)&&(a.session.warning=0,a.warning(),a.session.expired=setTimeout(function(){a.session.expired= 0;a.expired()},b))},b)},getValue:function(a){var b=a.val();"checkbox"!=a.attr("type")||a.is(":checked")||(b="");return b},getGroupedValue:function(a,b){var c=this,e=a.data("form-input-group"),d={};$("[data-form-input-group="+e+"]"+(b?":checked":"")).each(function(){$(this).hasClass("form-input-uncheck-all")||(d[$(this).attr("name")]=c.getValue($(this)))});return d},getModel:function(a,b){var c=this.collections[a];return c?c.find(function(a){return a.get("id")==b}):!1},updateModel:function(a){var b= {},c=a.data("model"),e=a.data("model-id"),d=a.data("form-input-group")&&void 0==a.data("form-input-group-save")?a.data("form-input-group"):a.attr("name"),f=this.getValue(a);a.data("form-input-group")&&void 0==a.data("form-input-group-save")&&(f=this.getGroupedValue(a,!1));b[d]=f;if(c=this.getModel(c,e))c.save(b),this.updateFormDate()},checkExpiration:function(a){var b=parseInt((new Date).getTime()/1E3),c=this.settings.get(this.settingFormDate);0!=c&&b-c>=this.session.time&&a()},updateFormDate:function(){this.settings.update({setting:this.settingFormDate, value:parseInt((new Date).getTime()/1E3)})},resetCollection:function(a){var b=[];a.each(function(a){b.push(a)});for(a=0;a<b.length;a++)b[a].destroy()},enable:function(a,b){var c="number"==typeof a?!0:!1,e=c?"step ":"",c=$("[data-form="+this.form+"] "+(c?"[data-form-step="+a+"]":"")+" "+I.Library.Form.inputs);a&&(a=e+a,b?(c.removeAttr("disabled").removeClass("disabled"),console.log("["+a+"] Form input fields enabled.")):(c.attr("disabled",!0).addClass("disabled"),console.log("["+a+"] Form input fields disabled.")))}, reset:function(a){var b=this;_.map(b.collections,function(a){b.resetCollection(a)});clearTimeout(b.session.warning);clearTimeout(b.session.expired);b.session.warning=0;b.session.expired=0;b.settings.update({setting:b.settingFormDate,value:0});a.init&&(a.init(),setTimeout(function(){$("[data-form="+a.form+"]").remove();b.settings.update({setting:b.settingFormDate,value:0})},500));console.log("["+a.form+"] Form has been reset.")},clearValidation:function(){this.formMarker.removeClass("data-form-input-success data-form-input-error"); this.formIcon.removeClass("data-form-icon-success data-form-icon-error");this.inputElement.removeAttr("data-form-validation")},markInput:function(a){var b=!0;this.clearValidation();a&&this.inputElement.attr("type")&&this.inputElement.attr("type").match(/radio|checkbox/)&&(b=!1);b&&(this.formMarker.addClass("data-form-input-"+(a?"success":"error")),this.inputElement.attr("data-form-validation",a?"success":"error"));""==this.formMessage.text()&&this.formMessage.text("The "+this.formLabel+" is invalid."); a&&this.formMessage.text("");this.formIcon.addClass("data-form-icon-"+(a?"success":"error"))}}; I.Library.Form.validateInput=function(a){var b=0<a.closest("[data-form-input-other]").length?a.closest("[data-form-input-other]"):a.closest(this.inputContainer);this.inputElement=a;this.formValue=this.getValue(a);this.formLabel=a.data("form-label");this.defaultOption=a.data("form-default-option");this.formRules=a.data("form-rules")?a.data("form-rules").split(","):!1;this.formMessage=b.find(".data-form-input-message");this.formIcon=b.find(".data-form-input-icon");this.formMarker=b.find(a.data("form-input-marker")); this.formAllowedTags=a.data("form-allowed-tags");a.data("form-input-group")&&(this.formValue=this.getGroupedValue(a,!1));if("text"==a.attr("type")||a.is("textarea"))this.formValue=this.stripTags($.trim(this.formValue)),this.inputElement.val(this.formValue);if(this.formRules)for(b=0;b<this.formRules.length;b++){var c="test"+I.toCamel(this.formRules[b]);console.log("[Test Function] "+c);if(0==b&&"testRequired"!=c&&""==this.formValue)return this.clearValidation(),this.formMessage.text(""),!0;if(this[c](a))this.markInput(!0); else return this.markInput(!1),!0}else this.clearValidation(),this.formMessage.text("")}; I.Library.Form.validate=function(a){var b=this,c="[data-form="+b.form+"]"+("number"==typeof a?" [data-form-step="+a+"] ":""),e=!0,d="";I.Library.Form.enable(a,!1);$(c).each(function(){$(this).find(b.inputs).not("[data-form-validation=success]").each(function(){$(this).attr("data-form-rules")&&(b.validateInput($(this)),console.log("[Validate] Field name: "+$(this).attr("name")));0<$(this).closest("[data-form-fragment] [data-form-validation=error]").length&&""==d&&(d=$(this).closest("[data-form-fragment]").data("form-fragment"))})}); 0<$(c+" [data-form-validation=error]").length&&(e=!1);e||(I.Library.Form.enable(a,!0),""!=d&&Backbone.history.navigate(d,!0));return e};I.Library.Form.validateStep=function(a){return I.Library.Form.validate(a)}; I.Library.Form.stripTags=function(a){var b=this.formAllowedTags,b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join(""),c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,e=/\x3c!--[\s\S]*?--\x3e|<\?(?:php)?[\s\S]*?\?>/gi;if(null!=a)return a.replace(e,"").replace(c,function(a,c){return-1<b.indexOf("<"+c.toLowerCase()+">")?a:""})}; I.Library.Form.testRequired=function(){return""==this.formValue||this.defaultOption&&this.defaultOption==this.formValue?(this.formMessage.text("The "+this.formLabel+" field is required."),!1):!0};I.Library.Form.testNoSpaces=function(){this.formValue=this.formValue.replace(/\s+/g,"");this.inputElement.val(this.formValue);return!0};I.Library.Form.testNumber=function(){return/^([0-9])+$/.test(this.formValue)?!0:(this.formMessage.text("The "+this.formLabel+" must be a number."),!1)}; I.Library.Form.testEmail=function(){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(this.formValue)}; I.Library.Form.testLength=function(){var a=this.inputElement.data("form-rules-length");return a!=this.formValue.length?(this.formMessage.text("The "+this.formLabel+" must be "+a+"-character long."),!1):!0}; I.Library.Form.testDate=function(){var a=this.inputElement.closest("[data-form-input-date]").data("form-input-date"),b=$("#form-input-"+a+"-day"),c=$("#form-input-"+a+"-month"),e=$("#form-input-"+a+"-year"),d=b.find("option:selected").val(),f=c.find("option:selected").val(),g=e.find("option:selected").val(),f=(d?d:1)+"."+f+"."+(g?g:1977),d=!0;"error"==b.attr("data-form-validation")&&this.validateInput(b);"error"==c.attr("data-form-validation")&&this.validateInput(c);"error"==e.attr("data-form-validation")&& this.validateInput(e);if(/^\d\d?\.\d\d?\.\d\d\d?\d?$/.test(f)){if(e=f.split("."),b=parseInt(e[0],10),c=parseInt(e[1],10),e=parseInt(e[2],10),f=new Date(e,c-1,b),f.getMonth()+1!==c||f.getDate()!==b||f.getFullYear()!==e)d=!1}else d=!1;return d?!0:($("[data-form-input-date="+a+"] .data-form-input-message").text("The "+this.formLabel+" field is invalid."),!1)};